name: Create Release from Main

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: main   # checkout the correct branch name
          fetch-depth: 0                # fetch the whole repo history        

      - name: Git Version
        id: git-version
        uses: codacy/git-version@2.2.0
        with:
          release-branch: main
          prefix: v
          minor-identifier: _MINOR_
          major-identifier: _MAJOR_

      # ###########################
      # Generate OpenAPI definition
      # - name: Start MongoDB 🗃️ # We need Mongo to run
      #   uses: supercharge/mongodb-github-action@1.7.0
      #   with:
      #     mongodb-version: 4.4
      - name: UpdateOpenAPI stub
        run: |
          echo '{ "version": "${{ steps.git-version.outputs.version }} "}' > src/v3/autogenerated-openapi.json

      - name: Update package.json
        run: |
          VERSION=${{ steps.git-version.outputs.version }}
          CLEAN_VERSION="${VERSION/v/}"
          yarn version --no-git-tag-version --new-version ${CLEAN_VERSION}

      # - name: Update OpenAPI
      #   id: update-openapi
      #   run: |
      #     yarn install
      #     yarn build:openapi
      #   env:
      #     NODE_ENV: testing
      - name: Update branch with new OpenAPI spec 🔼
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          branch: main
          commit_message: Automated update of OpenAPI definition
          commit_options: '--no-verify --signoff'
          file_pattern: src/v3/autogenerated-openapi.json package.json
          commit_user_name: GitHub Actions Bot
          commit_user_email: github-actions-bot@milk.run
          commit_author: GitHub Actions Bot <github-actions-bot@milk.run>
      # ###########################

      - name: Release
        id: draft-release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          tag_name: ${{ steps.git-version.outputs.version }}
          files: |
            src/v3/autogenerated-openapi.json


      - name: Comment URL on PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'Draft release `${{ steps.git-version.outputs.version }}` created. See: ${{steps.draft-release.outputs.url}}'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
