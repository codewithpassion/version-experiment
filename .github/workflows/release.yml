name: Create Release from Main

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Git Version
        id: git-version
        uses: codacy/git-version@2.2.0
        with:
          release-branch: main

      - name: set version tag
        id: set-version-tag
        run: |
          echo "::set-output name=tag::v$(date +'%Y%m%d.T%H%M')"

      - name: Output version
        run: |
          echo #####
          echo Version ${{ steps.git-version.outputs.version }}
          echo Prev Version ${{ steps.git-version.outputs.previous-version }}


      # ###########################
      # Generate OpenAPI definition
      # - name: Start MongoDB üóÉÔ∏è # We need Mongo to run
      #   uses: supercharge/mongodb-github-action@1.7.0
      #   with:
      #     mongodb-version: 4.4
      # - name: Update OpenAPI
      #   id: update-openapi
      #   run: |
      #     yarn install
      #     yarn build:openapi
      #   env:
      #     NODE_ENV: testing
      - name: Update branch with new OpenAPI spec üîº
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Automated update of OpenAPI definition
          commit_options: '--no-verify --signoff'
          file_pattern: src/v3/autogenerated-openapi.json
          commit_user_name: GitHub Actions Bot
          commit_user_email: github-actions-bot@milk.run
          commit_author: GitHub Actions Bot <github-actions-bot@milk.run>
      # ###########################

      - name: Release
        id: draft-release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          tag_name: ${{ steps.set-version-tag.outputs.tag }}
          files: |
            src/v3/autogenerated-openapi.json


      - name: Comment URL on PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'Draft release `${{ steps.set-version-tag.outputs.tag }}` created. See: ${{steps.draft-release.outputs.url}}'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
